name: Profile Experiment â€” Rotate Variant

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at 00:00 UTC
  workflow_dispatch:       # Manual trigger for testing

permissions:
  contents: write

jobs:
  rotate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PROFILE_PAT }}

      - name: Draw random variant
        id: draw
        run: |
          # Deterministic seed from date for reproducibility
          TODAY=$(date -u +%Y-%m-%d)
          VARIANTS=("A" "B" "C")

          # Use date hash for reproducible randomization
          HASH=$(echo -n "$TODAY" | sha256sum | cut -c1-8)
          DECIMAL=$((16#$HASH))
          INDEX=$((DECIMAL % 3))
          VARIANT="${VARIANTS[$INDEX]}"

          echo "variant=$VARIANT" >> "$GITHUB_OUTPUT"
          echo "date=$TODAY" >> "$GITHUB_OUTPUT"
          echo "Selected variant $VARIANT for $TODAY"

      - name: Read previous variant
        id: previous
        run: |
          PREV=$(jq -r '.current.variant // "none"' profile-experiment/config.json)
          echo "variant=$PREV" >> "$GITHUB_OUTPUT"
          echo "Previous variant: $PREV"

      - name: Copy variant README
        run: |
          VARIANT="${{ steps.draw.outputs.variant }}"
          cp "profile-experiment/variants/README-${VARIANT}.md" README.md
          echo "Copied README-${VARIANT}.md to README.md"

      - name: Update bio via GitHub API
        env:
          GH_TOKEN: ${{ secrets.PROFILE_PAT }}
        run: |
          VARIANT="${{ steps.draw.outputs.variant }}"
          BIO=$(jq -r ".variants.${VARIANT}.bio" profile-experiment/config.json)
          gh api -X PATCH /user -f bio="$BIO"
          echo "Updated bio to: $BIO"

      - name: Update config.json
        run: |
          VARIANT="${{ steps.draw.outputs.variant }}"
          TODAY="${{ steps.draw.outputs.date }}"

          # Update current state
          jq --arg v "$VARIANT" --arg d "$TODAY" \
            '.current.variant = $v | .current.date = $d' \
            profile-experiment/config.json > tmp.json && mv tmp.json profile-experiment/config.json

          # Append to history
          jq --arg v "$VARIANT" --arg d "$TODAY" \
            '.history += [{"date": $d, "variant": $v}]' \
            profile-experiment/config.json > tmp.json && mv tmp.json profile-experiment/config.json

          # Set experiment start date if not set
          START=$(jq -r '.experiment.start_date // "null"' profile-experiment/config.json)
          if [ "$START" = "null" ]; then
            jq --arg d "$TODAY" \
              '.experiment.start_date = $d | .experiment.status = "running"' \
              profile-experiment/config.json > tmp.json && mv tmp.json profile-experiment/config.json
          fi

      - name: Check if pins need changing
        id: pins
        run: |
          VARIANT="${{ steps.draw.outputs.variant }}"
          PREV="${{ steps.previous.outputs.variant }}"

          if [ "$PREV" = "none" ] || [ "$PREV" = "$VARIANT" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            CURR_PINS=$(jq -c ".variants.${VARIANT}.pins" profile-experiment/config.json)
            PREV_PINS=$(jq -c ".variants.${PREV}.pins" profile-experiment/config.json)
            if [ "$CURR_PINS" = "$PREV_PINS" ]; then
              echo "changed=false" >> "$GITHUB_OUTPUT"
            else
              echo "changed=true" >> "$GITHUB_OUTPUT"
              echo "pins=$CURR_PINS" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Create pin-swap issue
        if: steps.pins.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.PROFILE_PAT }}
        run: |
          VARIANT="${{ steps.draw.outputs.variant }}"
          PINS="${{ steps.pins.outputs.pins }}"
          TODAY="${{ steps.draw.outputs.date }}"

          gh issue create \
            --title "Pin swap needed: Variant $VARIANT ($TODAY)" \
            --label "profile-experiment" \
            --body "Today's variant is **$VARIANT**. Please update pinned repos to:

          $PINS

          This is a manual step because the GitHub API doesn't support pinning repos."

      - name: Commit and push
        run: |
          VARIANT="${{ steps.draw.outputs.variant }}"
          TODAY="${{ steps.draw.outputs.date }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md profile-experiment/config.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "experiment: variant $VARIANT for $TODAY"
          git push
